<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Weather-Storm: Weather-Storm</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Weather-Storm
   </div>
   <div id="projectbrief">An event loop manager example project for Raspberry Pi</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part --><!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Weather-Storm </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Weather-Storm uses the <a href="https://github.com/klavinslab/elma">Elam</a> library as its infrastructure to implement an event loop process manager for Raspberry Pi to read weather data from an online server and use that to create visual indications, such as blinking LEDs and turning a stepper motor. In addition, I am using the <a href="https://github.com/yhirose/cpp-httplib">http.h</a>, <a href="https://github.com/nlohmann/json">json.h</a>, <a href="https://www.airspayce.com/mikem/bcm2835">bcm2835</a>, <a href="http://wiringpi.com/">WiringPi</a> for this project. In this project I am getting weather data of Seattle, WA from an online server <a href="https://api.openweathermap.org/">openweathermap</a> and using the current maximum temperature of Seattle, I am turning this information into visual responses using the Raspberry Pi. These visual responses are 8 LEDs that brighten while the stepper motor is rotating as many counts as the current maximum temperature of Seattle in Kelvins and finally, the LEDs dim slowly. I have used a stepper motor, a switching power supply, a TI DRV8711 stepper drive, and a Raspberry Pi for this project. The source code for this project is available <a href="https://github.com/Pnaghavi/Weather-Storm">on github</a>.</p>
<h2>Installation on Unix systems (e.g. Raspbian) </h2>
<p>First install required packages available through apt-get </p><pre class="fragment">sudo apt-get update
sudo apt-get install -y cmake
sudo apt-get install -y cppcheck
sudo apt-get install -y graphviz
sudo apt-get install -y doxygen
sudo apt-get install -y cmake
sudo apt-get install -y libssl-dev
</pre><p>Next, install Google Test </p><pre class="fragment">cd /usr/src
sudo git clone https://github.com/google/googletest.git
cd googletest
sudo mkdir install
cd install
sudo cmake ../
sudo make
sudo make install
</pre><p>Next, install the json library </p><pre class="fragment">sudo mkdir /usr/local/include/json
cd /usr/local/include/json
sudo curl -O -J -L https://github.com/nlohmann/json/releases/download/v3.5.0/json.hpp
sudo mv json.hpp json.h
</pre><p>Next, install httplib </p><pre class="fragment">cd /tmp
git clone https://github.com/klavins/cpp-httplib.git
sudo mkdir /usr/local/include/httplib
sudo mv /tmp/cpp-httplib/httplib.h /usr/local/include/httplib
</pre><p>Next, install bcm2835 Note: The commands bellow should be run as root Use this <a href="https://www.airspayce.com/mikem/bcm2835/">link</a> to download the latest bcm2835 library </p><pre class="fragment">cd ~
tar zxvf bcm2835-1.xx.tar.gz
cd bcm2835-1.xx
./configure
make
sudo make check
sudo make install
</pre><p>Now you should be ready to install Weather-Storm: </p><pre class="fragment">cd ~
mkdir Code
cd Code
git clone https://github.com/Pnaghavi/Weather-Storm.git
cd Weather-Storm
make
</pre><h2>Execution </h2>
<p>To run the Weather-Storm, type </p><pre class="fragment">./projectSrc/bin/storm
</pre><h2>Architecture </h2>
<p>Below, you can see the electrical setup of my project. All the items are labeled.</p>
<div class="image">
<img src="pics/setUP.jpg" alt="Electrical Setup"/>
</div>
<p>In the current setup the LEDs are controlled directly by the PI, but the stepper drive DRV8711 is not 100% controlled by the PI. There is a TI Launchpad board under the drive that listens to the PI's pulse train and passes it on to the STEP input of the drive, but the drive requires SPI com so that the drive registers are setup correctly. On powerup LaunchPad sets all the drive registers. The drive cannot work without the registers set. Raspberry Pi boards are able to run SPI com but after many hours I was not able to make that work</p>
<p>Below, you can see the class hierarchy of the software. There are four classes inheriting from the abstract State class of Elma. There is a class inheriting from StateMachine class of Elma. Finally, another class inheriting from the abstract Process class of Elma.</p>
<div class="image">
<img src="pics/classH.jpg" alt="Electrical Setup"/>
</div>
<p>The classes inheriting from State class of Elma are the states of the state machine. The class inheriting from StateMachine in elma constructs the states and adds the transitions of the states. The class inheriting from process runs the state machine. Currently the process runs through each state and once all tasks on that state is complete, the state machine manager emits the event for the next state. When the process runs for 100 seconds it constantly runs through all the states of the state machine periodically.</p>
<p>The diagram below shows the operation of the state machine. The evil project is made by the evil weather master, that has created an evil state machine. The evil state machine has four stets idle, get data, energize, and deenergize. In the idle stat the state machine waits for the start event to transition to the get data state. In the get data state the machine sends a get request to the server <a href="https://api.openweathermap.org/">https://api.openweathermap.org/</a> to obtain weather date of Seattle. Once that is complete the state machine will transition to the next state. The next state is the energize state, in this state this evil machine will rotate the stepper motor same number of counts as the current maximum temperature of Seattle, while brightening the LEDs to maximum brightness. Once that task is complete the state machine will transition to the next state which is deenergize, in this state the LEDs slowly dim until they are off and so this evil machine will deenergize. Finally, the state machine returns to the idle state.</p>
<div class="image">
<img src="pics/stateM.jpg" alt="Electrical Setup"/>
</div>
<p>This state machine is run by a process that monitors each state until all tasks are complete before emitting the transition to the next state. In addition, it will transfer the json object from the get data state to the energize and deenergize state. The main method will run this process for 100 seconds every 7 seconds. The evil state machine will run periodically for 100 seconds until the evil weather master gets bored and moves on to doing something worthwhile like helping the elderly cross the street.</p>
<h2>Results </h2>
<p>There is a <a href="https://github.com/Pnaghavi/Weather-Storm/blob/master/IMG_2348.mp4">video</a> on this repository showing the actual devices running the code.</p>
<p>The example below shows typical output on the terminal when the code is running: </p><pre class="fragment">Received data from server:

{
    "base": "stations",
    "clouds": {
        "all": 1
    },
    "cod": 200,
    "coord": {
        "lat": 47.61,
        "lon": -122.33
    },
    "dt": 1553394305,
    "id": 5809844,
    "main": {
        "humidity": 44,
        "pressure": 1022,
        "temp": 285.31,
        "temp_max": 287.15,
        "temp_min": 283.71
    },
    "name": "Seattle",
    "sys": {
        "country": "US",
        "id": 3417,
        "message": 0.0099,
        "sunrise": 1553349980,
        "sunset": 1553394323,
        "type": 1
    },
    "visibility": 16093,
    "weather": [
        {
            "description": "clear sky",
            "icon": "01n",
            "id": 800,
            "main": "Clear"
        }
    ],
    "wind": {
        "deg": 352.502,
        "speed": 1.66
    }
}
Seattle's max temperature in Kelvins: 287
Weather Storm State Machine started.
Weather Storm State Machine received data.
Weather Storm State Machine is energized.
Weather Storm State Machine is deenergized.
Weather Storm State Machine is idle.
</pre><h2>Acknowledgements </h2>
<p>Josh McCormick:</p><ul>
<li>Helped find the openweathermaps.com as the server for weather data</li>
<li>Helped setup my Raspberry Pi OS, Visual Studio Code, Docker</li>
<li>Helped on setup of Blinkt!</li>
<li>Helped me cover all the requirements of the project</li>
<li>Helped me project github structure</li>
</ul>
<h2>References </h2>
<p>WEBSITES:</p>
<p>Raspberry Pi Related:</p>
<p><a href="https://www.adafruit.com">www.adafruit.com</a> - Great resource for sensors and effectors and other RPi supplies. Also has a <a href="https://learn.adafruit.com/adafruits-raspberry-pi-lesson-6-using-ssh/overview">tutorial</a> for setting up SSH.</p>
<p><a href="https://raspberrypi.stackexchange.com/questions/42929/how-to-safely-switch-off-the-raspberry-pi/42945">raspberrypi.stackexchange.com</a> - Answers for how to properly shutdown your RPi.</p>
<p><a href="https://shop.pimoroni.com/products/blinkt">shop.pimoroni.com/products/blinkt</a> - The LED effector used with RPi for this project, an eight RGB LED indicator, cheap @ $6/ea at <a href="www.adafruit.com/?=Blinkt!">adafruit.com</a>, and simple to install.</p>
<p><a href="https://pimylifeup.com/raspberry-pi-visual-studio-code/">pimylifeup.com/raspberry-pi-visual-studio-code/</a> - Great guide. Raspberry Pi Visual Studio Code: Installing VS Code on Raspbian, By Gus, Sep 19 2018, updated Feb 17, 2019.</p>
<p>Implementation:</p>
<p><a href="https://www.rapidtables.com/web/color/RGB.html">www.rapidtables.com/web/color/RGB_Color.html</a> - Excellent reference for RGB Color Codes. Really helped in choosing colors for compass heading correlation.</p>
<p><a href="https://www.elecfreaks.com/learn-en/starter_kit_case_13">www.elecfreaks.com</a> - Example project that gave ideas of how I could implent my compass heading color correlation.</p>
<p><a href="https://www.calculateme.com/speed/miles-per-hour/to-knots">www.calculateme.com</a> - Provided quick factor to apply to convert from mph to knots.</p>
<p>Weather APIs:</p>
<p><a href="https://openweathermap.org/api">openweathermap.org/api</a> - The Weather API used for this project. Requires you make a free account which gives you access to Current weather data API among a few other weather APIs. Your account comes with an API key that is required when making API calls. <em><b>[FOR THIS CODE TO WORK, YOU WILL HAVE TO OBTAIN YOUR OWN API KEY TO APPEND TO THE END OF YOUR API CALLS]</b></em> (mine has not been provided ;) )</p>
<p><a href="https://www.programmableweb.com/news/top-10-weather-apis/analysis/2014/11/13">www.programmableweb.com</a> - Top 10 Weather APIs, By Janet Wagner. Provided weather API options for project.</p>
<p><a href="https://www.weather.gov/documenttation/services-web-api#/default/get stations%20 stationld%20 observations latest">www.weather.gov</a> - NOAA's API Web Service, the runner up to the API used for this project.</p>
<p>LIBRARIES:</p>
<p>Elma - Github</p>
<p><a href="https://github.com/klavinslab/elma">Elam</a> - Elma library as its infrastructure to implement an event loop process manager</p>
<p>clinkt - Github:</p>
<p><a href="https://github.com/DianaProbst/clinkt">github.com/DianaProbst/clinkt</a> - DianaProbst's clinkt repository provided a C++ ported version of the Python Library blinkt for the Pimoroni Blinkt LED display (and related APA102 pixel strips) on the Raspberry Pi. This library was instrumental for getting LED functionality on the Raspberry Pi using C++.</p>
<p>http - github:</p>
<p><a href="https://github.com/yhirose/cpp-httplib">http.h</a> to implement the get request</p>
<p>json - github:</p>
<p><a href="https://github.com/nlohmann/json">json.h</a> for json manipulation</p>
<p>Wiringpi - wiringpi.com</p>
<p><a href="http://wiringpi.com/">WiringPi</a> to control the stepper motor</p>
<p>bcm2835 - Other:</p>
<p><a href="www.airspayce.com/mikem/bcm2835">www.airspayece.com/mikem/bcm2835/</a> - C library for Boadcom BCM 2835 as used in Raspberry Pi. This is a required library when using the clinkt library, per the clinkt <a class="el" href="README_8md_source.html">README.md</a> file. Library is analagous to <a href="wiringpi.com">WiringPi</a>.</p>
<p><a href="https://raspberry-projects.com/pi/programming-in-c/io-pins/bcm2835-by-mike-mccauley">raspberry-projects.com/pi/programming-in-c/io-pins/bcm2835-by-mike-mccauley</a> - Resource on how to install the library correctly. Helped when troubleshooting library linker errors.</p>
<p><a href="https://stackwiringpioverflow.com/questions/4130681/undefined-reference-maybe-makefile-is-wrong">stackoverflow.com</a> - Helped me recognize why I was getting undefined reference errors.</p>
<p>"# WXR-Lite" </p>
</div></div><!-- contents -->
<!-- start footer part -->
  <hr class="footer"/><address class="footer"><small>
  Developed by Pirouz Naghavi</a> for UW ECE 590<br>
  Generated on Sat Mar 23 2019 23:36:15 for Weather-Storm by &#160;<a href="http://www.doxygen.org/index.html">
  Doxygen
  </a> 1.8.13
  </small></address>
  </body>
  </html>